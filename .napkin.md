# Napkin

## Corrections
| Date | Source | What Went Wrong | What To Do Instead |
|------|--------|----------------|-------------------|
| 2026-02-27 | bug | lake_app.py C001 tab filtered reviewed reaches using only `st.session_state.pending_fixes` (lost on refresh/restart) — C004 tab correctly queried `lint_fix_log` | Always query lint_fix_log for reviewed reaches (survives restarts), merge with session state for instant feedback |
| 2026-02-23 | self | Ran psql -f with relative path in worktree, schema didn't apply | Always use absolute paths for psql -f in worktrees |
| 2026-02-23 | self | PG schema had SERIAL PRIMARY KEY on facc_fix_log but DuckDB sends NULLs for that column | Use plain INTEGER, no PK constraint when mirroring DuckDB tables with auto-generated IDs |
| 2026-02-23 | self | v17c CALCULATE_DIST_OUT (Jan 22) corrupted 74,006 reaches (29.76%) — BFS flag heuristic at bifurcations uses max(available) when one child is -9999, never revisits | Never recalculate dist_out — use v17b values. v17c should only add hydro_dist_out (Dijkstra) as a new column |

## User Preferences
- Keep lint checks as WARNING when expected violations exist; add exclusion logic with clear comments explaining why some are allowed
- Concise plan mode output

## Patterns That Work
- Query v17b alongside v17c to determine whether issues are inherited or introduced
- Split lint violations into "expected" vs "unexpected" categories with a `violation_type` column in details DataFrame

## Patterns That Don't Work
- (none yet)

## Domain Notes
- **SWORD reused node IDs across versions** — same node_id can map to completely different rivers/coordinates between v17 releases. Always validate node coordinates spatially when joining across data sources. African rivers (ANJOBONY, BEMARIVO, ELE, V7_2, LILONGWE, SARARE) are affected; SA rivers are fine because their geometry didn't change.
- DB files live at `/Users/jakegearon/projects/SWORD/data/duckdb/`, NOT in worktree paths. DuckDB files are symlinked or accessed from main repo.
- PostgreSQL sword_v17c schema v1.7.0 matches DuckDB v17c as of 2026-02-23 (percentile SWOT columns, dn_node_id/up_node_id, node_order, topology_suspect/approved, facc_corrections, v17c_flow_corrections)
- MCP PostgreSQL tool connects to `postgres` db, not `sword_v17c` — use psql CLI for sword_v17c queries
- v17b geometry overwrite via dblink works: 248,673 reach geometries replaced with v17b originals for endpoint connectivity
- path_freq monotonicity violations (448 total) are ALL side-channel rejoin edges (main_side=1 or 2). v17b had 1,536 — v17c improved this 3x
- Issue #16 (path_freq=0/-9999 on connected reaches) is already fixed. All 23K nodata values are ghost reaches (type=6)
- `deploy/reviewer/lint/` has a separate copy of lint checks — must keep in sync with `src/sword_duckdb/lint/`
- Pre-existing ruff warning in `deploy/reviewer/lint/checks/topology.py:432` — unused `total_reaches` variable in T006
